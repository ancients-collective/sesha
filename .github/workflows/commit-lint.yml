name: Commit Lint

on:
  pull_request:
    branches: [main, develop]

permissions:
  contents: read

jobs:
  lint-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          PATTERN='^(feat|fix|docs|chore|refactor|test|ci|build|perf|style)(\([a-z0-9_-]+\))?!?: .{1,100}$'
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          FAILED=0
          while IFS= read -r MSG; do
            FIRST_LINE=$(echo "$MSG" | head -n1)
            if ! echo "$FIRST_LINE" | grep -Eq "$PATTERN"; then
              echo "::error::Non-conforming commit message: $FIRST_LINE"
              echo ""
              echo "  Expected format: <type>[optional scope]: <description>"
              echo "  Types: feat, fix, docs, chore, refactor, test, ci, build, perf, style"
              echo "  Scopes: engine, loader, output, context, cli, checks, release (optional)"
              echo "  Example: feat(engine): add kernel_param_value function"
              echo ""
              FAILED=1
            fi
          done < <(git log --format='%s' "$BASE".."$HEAD")

          if [ "$FAILED" -eq 1 ]; then
            echo ""
            echo "See: https://www.conventionalcommits.org/en/v1.0.0/"
            exit 1
          fi

          echo "All commit messages conform to Conventional Commits."
